% Add this to your method.tex file after the Implementation Details section

\subsection{Pipeline Workflow}

Figure~\ref{fig:pipeline_workflow} illustrates the complete CroDINO pipeline as implemented in our testing framework. The workflow demonstrates how our backbone-agnostic architecture processes image pairs through multiple stages to produce orientation estimates.

\begin{figure}[htbp]
\centering
\begin{tikzpicture}[
    node distance=1.0cm and 2.0cm,
    auto,
    thick,
    input/.style={rectangle, draw, font=\scriptsize, align=center, minimum width=2cm, minimum height=0.8cm, fill=blue!20},
    process/.style={rectangle, draw, font=\scriptsize, align=center, minimum width=2cm, minimum height=0.8cm, fill=orange!20},
    model/.style={rectangle, draw, font=\scriptsize, align=center, minimum width=2cm, minimum height=0.8cm, fill=green!20},
    output/.style={rectangle, draw, font=\scriptsize, align=center, minimum width=2cm, minimum height=0.8cm, fill=red!20},
    arrow/.style={->, >=stealth}
]

% Row 1: Input and Preprocessing
\node[input] (dataset) {Dataset\\Loading};
\node[process, right=of dataset] (batch) {Batch\\Processing};
\node[process, right=of batch] (transform) {Image\\Transforms};

% Row 2: Feature Extraction
\node[model, below=of dataset] (backbone) {Backbone\\Model};
\node[model, right=of backbone] (tokens) {Token\\Extraction};
\node[process, right=of tokens] (grid) {Grid Size\\Calculation};

% Row 3: Semantic Processing
\node[process, below=of backbone] (sky) {Sky\\Filtering};
\node[process, right=of sky] (depth) {Depth\\Estimation};
\node[process, right=of depth] (mask) {Mask\\Generation};

% Row 4: Token Aggregation
\node[process, below=of sky] (vertical) {Vertical\\Aggregation};
\node[process, right=of vertical] (radial) {Radial\\Aggregation};
\node[process, right=of radial] (weight) {Multi-Layer\\Weighting};

% Row 5: Orientation Estimation
\node[process, below=of vertical] (align) {Cross-Modal\\Alignment};
\node[process, right=of align] (search) {Exhaustive\\Search};
\node[output, right=of search] (result) {Orientation\\$\theta^*$};

% Row 6: Analysis and Output
\node[output, below=of align] (error) {Error\\Calculation};
\node[output, right=of error] (stats) {Statistics\\Generation};
\node[output, right=of stats] (viz) {Visualization\\\& Storage};

% Arrows - Main Pipeline Flow
\draw[arrow] (dataset) -- (batch);
\draw[arrow] (batch) -- (transform);
\draw[arrow] (transform) -- (grid);
\draw[arrow] (grid) -- (tokens);
\draw[arrow] (tokens) -- (backbone);
\draw[arrow] (backbone) -- (sky);
\draw[arrow] (sky) -- (depth);
\draw[arrow] (depth) -- (mask);
\draw[arrow] (mask) -- (weight);
\draw[arrow] (weight) -- (radial);
\draw[arrow] (radial) -- (vertical);
\draw[arrow] (vertical) -- (align);
\draw[arrow] (align) -- (search);
\draw[arrow] (search) -- (result);
\draw[arrow] (result) -- (viz);
\draw[arrow] (viz) -- (stats);
\draw[arrow] (stats) -- (error);

% Data flow annotations
\node[below=0.2cm of tokens, font=\tiny] {$\mathbf{F}_g, \mathbf{F}_a$};
\node[below=0.2cm of mask, font=\tiny] {$M_{grid}, d_{i,j}$};
\node[below=0.2cm of weight, font=\tiny] {3-layer tokens};
\node[below=0.2cm of result, font=\tiny] {$\theta^*, \text{conf}$};

% Phase labels
\node[above=0.3cm of dataset, font=\small\bfseries] {Data Input};
\node[above=0.3cm of backbone, font=\small\bfseries] {Feature Extraction};
\node[above=0.3cm of sky, font=\small\bfseries] {Preprocessing};
\node[above=0.3cm of vertical, font=\small\bfseries] {Token Aggregation};
\node[above=0.3cm of align, font=\small\bfseries] {Orientation Estimation};
\node[above=0.3cm of error, font=\small\bfseries] {Analysis \& Output};

\end{tikzpicture}
\caption{Complete CroDINO pipeline workflow showing the progression from raw image pairs to orientation estimates. The pipeline demonstrates backbone-agnostic processing through six main phases: data input, feature extraction, preprocessing (sky filtering and depth estimation), multi-layer token aggregation, orientation estimation via cross-modal alignment, and comprehensive analysis with visualization output.}
\label{fig:pipeline_workflow}
\end{figure}

\subsubsection{Key Pipeline Components}

The implementation workflow consists of the following critical components:

\textbf{Data Processing}: The \texttt{test()} function iterates through batches of image pairs, applying dynamic preprocessing based on the selected backbone architecture. Grid size is calculated as $G = \sqrt{N}$ where $N$ is the number of extracted tokens.

\textbf{Feature Extraction}: The \texttt{model.forward()} method provides backbone-agnostic token extraction, supporting DINOv2 ($16 \times 16$ grid, 768-dim), CLIP ($14 \times 14$ grid, 768-dim), and ResNet50 (variable grid, 2048-dim) architectures.

\textbf{Semantic Preprocessing}: 
\begin{itemize}
    \item \texttt{apply\_sky\_filter()}: CNN-based sky segmentation with grid-level majority voting
    \item \texttt{apply\_depth\_estimation()}: Depth-Anything model with grid downsampling to match token resolution
\end{itemize}

\textbf{Token Aggregation}:
\begin{itemize}
    \item \texttt{get\_averaged\_vertical\_tokens()}: Depth-weighted aggregation along ground image columns with sky masking
    \item \texttt{get\_averaged\_radial\_tokens()}: Linear-weighted aggregation along aerial image radials from center
    \item Both functions produce foreground, middleground, and background layer representations
\end{itemize}

\textbf{Orientation Estimation}: \texttt{find\_alignment()} performs exhaustive search over the orientation space $[0, 360)$ with angular resolution $\Delta\theta = \text{FOV}_x / G$, minimizing cosine distance between corresponding vertical and radial feature aggregations.

\textbf{Analysis and Validation}: The pipeline accumulates delta yaw errors, computes statistical measures (mean, standard deviation, median), and optionally generates comprehensive visualizations showing prediction accuracy, confidence distributions, and alignment quality.
