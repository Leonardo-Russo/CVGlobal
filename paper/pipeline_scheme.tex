\documentclass{standalone}
\usepackage{tikz}
\usepackage{xcolor}
\usepackage{amsmath}
\usepackage{amssymb}
\usetikzlibrary{shapes,arrows,positioning,fit,calc}

\definecolor{inputcolor}{RGB}{173,216,230}
\definecolor{processcolor}{RGB}{255,218,185}
\definecolor{modelcolor}{RGB}{144,238,144}
\definecolor{outputcolor}{RGB}{255,182,193}
\definecolor{decisioncolor}{RGB}{255,255,224}

\begin{document}

\begin{tikzpicture}[
    node distance=1.5cm,
    auto,
    thick,
    main node/.style={rectangle, draw, font=\small, align=center, minimum width=2.5cm, minimum height=1cm},
    input node/.style={main node, fill=inputcolor},
    process node/.style={main node, fill=processcolor},
    model node/.style={main node, fill=modelcolor},
    output node/.style={main node, fill=outputcolor},
    decision node/.style={diamond, draw, font=\small, align=center, fill=decisioncolor, aspect=2},
    arrow/.style={->, >=stealth, thick}
]

% Input Data
\node[input node] (dataset) {Dataset Loading\\(CVUSA/CITIES/VIGOR)};
\node[input node, below=of dataset] (dataloader) {DataLoader\\(Batch Processing)};

% Image Pair Processing
\node[process node, right=3cm of dataloader] (imagepair) {Image Pair\\Extraction};
\node[process node, below=of imagepair] (transforms) {Ground \& Aerial\\Transforms\\(224Ã—224)};

% Model Processing
\node[model node, right=3cm of transforms] (backbone) {Backbone Model\\(DINOv2/CLIP/ResNet50)};
\node[model node, below=of backbone] (tokens) {Token Extraction\\$\mathbf{F}_g, \mathbf{F}_a$};
\node[process node, below=of tokens] (gridsize) {Dynamic Grid Size\\$G = \sqrt{N}$};

% Sky and Depth Processing
\node[process node, right=3cm of gridsize] (skyfilter) {Sky Filter\\(SkyFilter)};
\node[process node, below=of skyfilter] (skymask) {Sky Mask\\$M_{grid} \in \{0,1\}^{G \times G}$};
\node[process node, below=of skymask] (depth) {Depth Estimation\\(Depth-Anything)};
\node[process node, below=of depth] (depthgrid) {Depth Grid\\$d_{i,j} \in [0,1]$};

% Token Aggregation
\node[process node, right=3cm of depthgrid] (vertical) {Vertical Token\\Aggregation};
\node[process node, below=of vertical] (radial) {Radial Token\\Aggregation};
\node[process node, below=of radial] (weighted) {Multi-Layer\\Depth Weighting};

% Orientation Estimation
\node[process node, right=3cm of weighted] (alignment) {Cross-Modal\\Alignment};
\node[process node, below=of alignment] (cosine) {Cosine Distance\\Minimization};
\node[process node, below=of cosine] (search) {Exhaustive Search\\$\theta^* = \arg\min \mathcal{L}(\theta)$};

% Results and Visualization
\node[output node, right=3cm of search] (orientation) {Best Orientation\\$\theta^*$};
\node[output node, below=of orientation] (confidence) {Confidence Score\\Z-score};
\node[output node, below=of confidence] (deltayaw) {Delta Yaw Error\\$|\theta^* - \theta_{GT}|$};

% Visualization Branch
\node[decision node, below=of deltayaw] (visualize) {Create\\Figs?};
\node[output node, below left=of visualize] (plots) {Visualization\\Plots};
\node[output node, below right=of visualize] (results) {Results\\Storage};

% Arrows - Main Pipeline
\draw[arrow] (dataset) -- (dataloader);
\draw[arrow] (dataloader) -- (imagepair);
\draw[arrow] (imagepair) -- (transforms);
\draw[arrow] (transforms) -- (backbone);
\draw[arrow] (backbone) -- (tokens);
\draw[arrow] (tokens) -- (gridsize);
\draw[arrow] (gridsize) -- (skyfilter);
\draw[arrow] (skyfilter) -- (skymask);
\draw[arrow] (skymask) -- (depth);
\draw[arrow] (depth) -- (depthgrid);
\draw[arrow] (depthgrid) -- (vertical);
\draw[arrow] (vertical) -- (radial);
\draw[arrow] (radial) -- (weighted);
\draw[arrow] (weighted) -- (alignment);
\draw[arrow] (alignment) -- (cosine);
\draw[arrow] (cosine) -- (search);
\draw[arrow] (search) -- (orientation);
\draw[arrow] (orientation) -- (confidence);
\draw[arrow] (confidence) -- (deltayaw);
\draw[arrow] (deltayaw) -- (visualize);
\draw[arrow] (visualize) -- node[left] {Yes} (plots);
\draw[arrow] (visualize) -- node[right] {No} (results);

% Additional annotations
\node[above=0.5cm of dataset, font=\scriptsize] {Input Phase};
\node[above=0.5cm of backbone, font=\scriptsize] {Feature Extraction};
\node[above=0.5cm of skyfilter, font=\scriptsize] {Preprocessing};
\node[above=0.5cm of vertical, font=\scriptsize] {Token Aggregation};
\node[above=0.5cm of alignment, font=\scriptsize] {Orientation Estimation};
\node[above=0.5cm of orientation, font=\scriptsize] {Output \& Analysis};

% Detailed annotations for key processes
\node[below=0.3cm of tokens, font=\tiny, align=center] {Ground: $\mathbf{F}_g \in \mathbb{R}^{N \times D}$\\Aerial: $\mathbf{F}_a \in \mathbb{R}^{N \times D}$};
\node[below=0.3cm of weighted, font=\tiny, align=center] {Fore/Mid/Back\\Layers};
\node[below=0.3cm of search, font=\tiny, align=center] {$\Delta\theta = \frac{\text{FOV}_x}{G}$};

\end{tikzpicture}

\end{document}
